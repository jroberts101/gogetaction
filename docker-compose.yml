services:
  # NGINX for routing requests
  nginx:
    image: nginx:alpine
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./infra/docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./certs:/etc/nginx/certs
    depends_on:
      - frontend
      - backend-api
    networks:
      - gogetaction

  # Frontend - Vite dev server
  frontend:
    image: node:20-alpine
    working_dir: /app
    ports:
      - '5173:5173'
    command: >
      sh -c "
        corepack enable && 
        corepack prepare pnpm@latest --activate && 
        echo 'Cleaning node_modules cache for fresh install...' &&
        rm -rf node_modules/.vite &&
        pnpm install --force && 
        echo 'Starting Vite with optimized settings for Docker...' &&
        pnpm exec vite --host 0.0.0.0 --force"
    volumes:
      - ./packages/frontend:/app
    environment:
      - NODE_ENV=development
      - VITE_BACKEND_URL=${VITE_BACKEND_URL}
    networks:
      - gogetaction

  # Backend API
  backend-api:
    image: node:20-alpine
    working_dir: /app
    ports:
      - '5001:5001' # Changed to map 5001 to 5001
      - '9229:9229' # For debugging
    command: sh -c "corepack enable && corepack prepare pnpm@latest --activate && pnpm install && pnpm dev"
    volumes:
      - ./packages/backend-api:/app
    environment:
      - NODE_ENV=development
      - BACKEND_PORT=5001 # Changed from 5000 to 5001
      - MONGO_URI=mongodb://mongo:27017/gogetaction
    depends_on:
      - mongo
    networks:
      - gogetaction

  # Email testing service
  mailpit:
    image: axllent/mailpit:v1.24
    container_name: mailpit
    restart: unless-stopped
    ports:
      - '1025:1025' # SMTP port
      - '8025:8025' # Web UI port
    environment:
      - MP_SMTP_AUTH_ACCEPT_ANY=1 # Accept any SMTP auth (useful for testing)
      - MP_SMTP_AUTH_ALLOW_INSECURE=1 # Allow insecure auth for dev
      - TZ=UTC
    volumes:
      - mailpit_data:/data
    networks:
      - gogetaction

  # Keycloak - Identity and Access Management
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    command: start-dev
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://postgres:5432/keycloak
      - KC_DB_USERNAME=${POSTGRES_USER:-keycloak}
      - KC_DB_PASSWORD=${POSTGRES_PASSWORD:-keycloak}
    ports:
      - '8080:8080'
    depends_on:
      - postgres
    networks:
      - gogetaction

  # PostgreSQL - Database for Keycloak
  postgres:
    image: postgres:14
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=${POSTGRES_USER:-keycloak}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-keycloak}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - gogetaction

  # MongoDB
  mongo:
    image: mongo:latest
    volumes:
      - mongo_data:/data/db
    networks:
      - gogetaction

networks:
  gogetaction:
    driver: bridge

volumes:
  postgres_data:
  mongo_data:
  mailpit_data:
